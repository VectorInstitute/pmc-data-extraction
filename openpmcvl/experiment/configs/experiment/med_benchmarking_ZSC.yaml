
# @package _global_

defaults:
  - /datasets@datasets.test.bach: BACH
  - /datasets/transforms@datasets.test.bach.transform: biomedclip_vision_transform
  # - /datasets@datasets.test.ham10k: HAM10000
  # - /datasets/transforms@datasets.test.ham10k.transform: biomedclip_vision_transform
  # - /datasets@datasets.test.lc25k_lung: LC25000
  # - /datasets/transforms@datasets.test.lc25k_lung.transform: biomedclip_vision_transform
  # - /datasets@datasets.test.lc25k_colon: LC25000
  # - /datasets/transforms@datasets.test.lc25k_colon.transform: biomedclip_vision_transform
  # - /datasets@datasets.test.nck_crc: NckCrc
  # - /datasets/transforms@datasets.test.nck_crc.transform: biomedclip_vision_transform
  # - /datasets@datasets.test.pad_ufes_20: PadUfes20
  # - /datasets/transforms@datasets.test.pad_ufes_20.transform: biomedclip_vision_transform
  # - /datasets@datasets.test.pcam: PCAM
  # - /datasets/transforms@datasets.test.pcam.transform: biomedclip_vision_transform
  # - /datasets@datasets.test.sicap: SICAP
  # - /datasets/transforms@datasets.test.sicap.transform: biomedclip_vision_transform
  # - /datasets@datasets.test.pathmnist: MedMNISTPlus
  # - /datasets/transforms@datasets.test.pathmnist.transform: biomedclip_vision_transform
  # - /datasets@datasets.test.dermamnist: MedMNISTPlus
  # - /datasets/transforms@datasets.test.dermamnist.transform: biomedclip_vision_transform
  # - /datasets@datasets.test.octmnist: MedMNISTPlus
  # - /datasets/transforms@datasets.test.octmnist.transform: biomedclip_vision_transform
  # - /datasets@datasets.test.pneumoniamnist: MedMNISTPlus
  # - /datasets/transforms@datasets.test.pneumoniamnist.transform: biomedclip_vision_transform
  # - /datasets@datasets.test.retinamnist: MedMNISTPlus
  # - /datasets/transforms@datasets.test.retinamnist.transform: biomedclip_vision_transform
  # - /datasets@datasets.test.breastmnist: MedMNISTPlus
  # - /datasets/transforms@datasets.test.breastmnist.transform: biomedclip_vision_transform
  # - /datasets@datasets.test.bloodmnist: MedMNISTPlus
  # - /datasets/transforms@datasets.test.bloodmnist.transform: biomedclip_vision_transform
  # - /datasets@datasets.test.tissuemnist: MedMNISTPlus
  # - /datasets/transforms@datasets.test.tissuemnist.transform: biomedclip_vision_transform
  # - /datasets@datasets.test.organamnist: MedMNISTPlus
  # - /datasets/transforms@datasets.test.organamnist.transform: biomedclip_vision_transform
  # - /datasets@datasets.test.organcmnist: MedMNISTPlus
  # - /datasets/transforms@datasets.test.organcmnist.transform: biomedclip_vision_transform
  # - /datasets@datasets.test.organsmnist: MedMNISTPlus
  # - /datasets/transforms@datasets.test.organsmnist.transform: biomedclip_vision_transform
  - /datasets/tokenizers@dataloader.train.collate_fn.batch_processors.text: HFCLIPTokenizer
  - /datasets/tokenizers@dataloader.val.collate_fn.batch_processors.text: HFCLIPTokenizer
  - /modules/encoders@task.encoders.text: HFCLIPTextEncoderWithProjection
  - /modules/encoders@task.encoders.rgb: HFCLIPVisionEncoderWithProjection
  - /modules/layers@task.postprocessors.norm_and_logit_scale.norm: L2Norm
  - /modules/layers@task.postprocessors.norm_and_logit_scale.logit_scale: LearnableLogitScaling
  - /modules/losses@task.loss: CLIPLoss
  - /modules/optimizers@task.optimizer: AdamW
  - /modules/lr_schedulers@task.lr_scheduler.scheduler: CosineAnnealingLR
  - /eval_task@task.evaluation_tasks.classification.task: ZeroShotClassification
  - /trainer/callbacks@trainer.callbacks.lr_monitor: LearningRateMonitor
  - /trainer/callbacks@trainer.callbacks.model_checkpoint: ModelCheckpoint
  - /trainer/callbacks@trainer.callbacks.early_stopping: EarlyStopping
  - /trainer/callbacks@trainer.callbacks.model_summary: ModelSummary
  - /datasets/tokenizers@task.evaluation_tasks.classification.task.tokenizer: HFCLIPTokenizer
  - /trainer/logger@trainer.logger.wandb: WandbLogger
  - override /task: ContrastivePretraining
  - _self_

seed: 0

job_type: eval

datasets:
  test:
    # ham10k:
    #   transform:
    #     job_type: eval
    # pcam:
    #   transform:
    #     job_type: eval
    bach:
      split: test
      transform:
        job_type: eval
    # lc25k_lung:
    #   split: test
    #   transform:
    #     job_type: eval
    # lc25k_colon:
    #   root_dir: ${oc.env:LC25000_COLON_ROOT_DIR}
    #   split: test
    #   organ: colon
    #   transform:
    #     job_type: eval
    # pathmnist:
    #   split: test
    #   name: pathmnist
    #   transform:
    #     job_type: eval
    # dermamnist:
    #   split: test
    #   name: dermamnist
    #   transform:
    #     job_type: eval
    # octmnist:
    #   split: test
    #   name: octmnist
    #   transform:
    #     job_type: eval
    # pneumoniamnist:
    #   split: test
    #   name: pneumoniamnist
    #   transform:
    #     job_type: eval
    # retinamnist:
    #   split: test
    #   name: retinamnist
    #   transform:
    #     job_type: eval
    # breastmnist:
    #   split: test
    #   name: breastmnist
    #   transform:
    #     job_type: eval
    # bloodmnist:
    #   split: test
    #   name: bloodmnist
    #   transform:
    #     job_type: eval
    # tissuemnist:
    #   split: test
    #   name: tissuemnist
    #   transform:
    #     job_type: eval
    # organamnist:
    #   split: test
    #   name: organamnist
    #   transform:
    #     job_type: eval
    # organcmnist:
    #   split: test
    #   name: organcmnist
    #   transform:
    #     job_type: eval
    # organsmnist:
    #   split: test
    #   name: organsmnist
    #   transform:
    #     job_type: eval
    # nck_crc:
    #   split: validation
    #   transform:
    #     job_type: eval
    # pad_ufes_20:
    #   split: test
    #   transform:
    #     job_type: eval
    # sicap:
    #   split: test
    #   transform:
    #     job_type: eval

dataloader:
  train:
    batch_size: 32
    num_workers: 4
  val:
    batch_size: 32
    num_workers: 4

task:
  postprocessors:
    norm_and_logit_scale:
      norm:
        dim: -1
      logit_scale:
        learnable: True
  modality_module_mapping:
    text:
      postprocessor_key: norm_and_logit_scale
    rgb:
      postprocessor_key: norm_and_logit_scale
  optimizer:
    betas:
    - 0.9
    - 0.98
    lr: 5.0e-5
    weight_decay: 0.1
    eps: 1.0e-6
  lr_scheduler:
    scheduler:
      T_max: 107_559 # make sure to change this if max_epochs or accumulate_grad_batches is changed
    extras:
      interval: step
  loss:
    gather_with_grad: True
  evaluation_tasks:
    classification:
      task:
        task_specs:
          - top_k: [1]
            query_modality: rgb
      run_on_validation: false
      run_on_test: true
  compute_validation_loss: False
  compute_test_loss: False


trainer:
  max_epochs: 20
  precision: 16-mixed
  deterministic: False
  benchmark: True
  sync_batchnorm: False # set to True if using DDP with batchnorm
  log_every_n_steps: 100
  accumulate_grad_batches: 4
  check_val_every_n_epoch: 1
  callbacks:
    model_checkpoint:
      monitor: val/loss
      save_top_k: 1
      save_last: True
      every_n_epochs: 1
      dirpath: /checkpoint/${oc.env:USER}/${oc.env:SLURM_JOB_ID} # only works on Vector SLURM environment
    early_stopping:
      monitor: val/loss
      patience: 5
      mode: min
    model_summary:
      max_depth: 2

tags:
  - ${experiment_name}
  - contrastive pretraining
  - rgb
  - text
  - clip
  - roco
  - quilt
  - mimiciv
  - pmc_oa
  - medmultimodal
